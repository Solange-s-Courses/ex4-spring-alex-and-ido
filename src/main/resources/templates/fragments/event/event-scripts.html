<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:fragment="event-scripts(eventId, userRole)">
    <!-- Include Navbar Scripts -->
    <div th:replace="~{fragments/layout :: navbar-scripts}"></div>

    <!-- Include Toast Notification -->
    <div th:replace="~{fragments/common/toast-notification :: toast}"></div>

    <!-- Event Management JavaScript -->
    <script th:inline="javascript">
        const eventId = /*[[${eventId}]]*/ 0;
        const userRole = /*[[${userRole}]]*/ 'user';

        // Show Add Responsibility Modal
        function showAddResponsibilityModal() {
            const modal = document.getElementById('addResponsibilityModal');

            // Prevent opening if already open or loading
            if (modal.classList.contains('show') || modal.classList.contains('loading')) {
                return;
            }

            // Set loading state
            modal.classList.add('loading');

            fetch(`/chief/events/${eventId}/available-responsibilities`)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        showToast('No responsibilities available to add. All responsibilities are already assigned to this event.', 'info');
                        return;
                    }

                    const select = document.getElementById('responsibilitySelect');
                    select.innerHTML = '<option value="">Choose a responsibility...</option>';

                    data.forEach(responsibility => {
                        const option = document.createElement('option');
                        option.value = responsibility.id;
                        option.textContent = responsibility.name;
                        if (responsibility.description) {
                            option.textContent += ` - ${responsibility.description}`;
                        }
                        select.appendChild(option);
                    });

                    // Show modal only after successful load
                    modal.classList.add('show');
                })
                .catch(error => {
                    console.error('Error loading responsibilities:', error);
                    showToast('Error loading available responsibilities', 'error');
                })
                .finally(() => {
                    // Always remove loading state
                    modal.classList.remove('loading');
                });
        }

        // Hide Add Responsibility Modal
        function hideAddResponsibilityModal() {
            const modal = document.getElementById('addResponsibilityModal');
            modal.classList.remove('show');
            modal.classList.remove('loading'); // Also remove loading state when closing
        }

        // Add Selected Responsibility
        function addSelectedResponsibility() {
            const select = document.getElementById('responsibilitySelect');
            const responsibilityId = select.value;
            const modal = document.getElementById('addResponsibilityModal');

            if (!responsibilityId) {
                alert('Please select a responsibility');
                return;
            }

            // Prevent multiple submissions
            if (modal.classList.contains('submitting')) {
                return;
            }

            modal.classList.add('submitting');

            const formData = new FormData();
            formData.append('responsibilityId', responsibilityId);

            fetch(`/chief/events/${eventId}/add-responsibility`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateResponsibilitiesList(data.responsibilities);
                        hideAddResponsibilityModal();
                    } else {
                        alert(data.message || 'Error adding responsibility');
                    }
                })
                .catch(error => {
                    console.error('Error adding responsibility:', error);
                    alert('Error adding responsibility');
                })
                .finally(() => {
                    modal.classList.remove('submitting');
                });
        }

        // Global variable to store responsibility info for removal
        let responsibilityToRemove = null;

        // Show Remove Responsibility Modal
        function removeResponsibility(responsibilityId) {
            // Find responsibility name from current list
            const responsibilityItem = document.querySelector(`[onclick*="removeResponsibility(${responsibilityId})"]`).closest('.responsibility-item');
            const responsibilityName = responsibilityItem.querySelector('.responsibility-name').textContent;

            // Store for confirmation
            responsibilityToRemove = { id: responsibilityId, name: responsibilityName };

            // Update modal content
            document.getElementById('responsibilityNameToRemove').textContent = responsibilityName;

            // Show modal
            document.getElementById('removeResponsibilityModal').classList.add('show');
        }

        // Hide Remove Responsibility Modal
        function hideRemoveResponsibilityModal() {
            document.getElementById('removeResponsibilityModal').classList.remove('show');
            responsibilityToRemove = null;
        }

        // Confirm Remove Responsibility
        function confirmRemoveResponsibility() {
            if (!responsibilityToRemove) {
                return;
            }

            const formData = new FormData();
            formData.append('responsibilityId', responsibilityToRemove.id);

            fetch(`/chief/events/${eventId}/remove-responsibility`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateResponsibilitiesList(data.responsibilities);
                        hideRemoveResponsibilityModal();
                    } else {
                        alert(data.message || 'Error removing responsibility');
                    }
                })
                .catch(error => {
                    console.error('Error removing responsibility:', error);
                    alert('Error removing responsibility');
                });
        }

        // Update Responsibilities List
        function updateResponsibilitiesList(responsibilities) {
            const container = document.getElementById('responsibilitiesContainer');

            if (!responsibilities || responsibilities.length === 0) {
                container.innerHTML = '<div class="no-responsibilities" id="emptyState">No responsibilities assigned yet</div>';
                return;
            }

            let html = '';
            responsibilities.forEach(resp => {
                html += `
                    <div class="responsibility-item">
                        ${userRole === 'chief' ? `<button class="remove-responsibility-btn" onclick="removeResponsibility(${resp.id})">Ã—</button>` : ''}
                        <div class="responsibility-name">${resp.name}</div>
                        <div class="responsibility-description ${!resp.description ? 'no-description' : ''}">
                            ${resp.description || 'No description'}
                        </div>
                        <div class="responsibility-managers">
                            ${resp.managers && resp.managers.length > 0 ? (function() {
                                let managerHtml = '';
                                // Show first 2 managers
                                for (let i = 0; i < Math.min(2, resp.managers.length); i++) {
                                    managerHtml += `<span class="manager-badge">${resp.managers[i]}</span>`;
                                }
                                // Add counter if more than 2 managers
                                if (resp.managers.length > 2) {
                                    managerHtml += `<span class="manager-badge manager-counter">+${resp.managers.length - 2} more</span>`;
                                }
                                return managerHtml;
                                })() : '<div class="no-managers">No managers assigned</div>'
                            }
                        </div>
                        <div class="responsibility-actions">
                            <a href="/responsibility/view/${resp.id}" class="view-responsibility-btn">View Details</a>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Close modal when clicking outside
        document.getElementById('addResponsibilityModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideAddResponsibilityModal();
            }
        });

        // Close remove modal when clicking outside
        document.getElementById('removeResponsibilityModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideRemoveResponsibilityModal();
            }
        });

        // Edit Event Modal Functions
        function showEditEventModalFromData(button) {
            const eventName = button.getAttribute('data-event-name');
            const eventDescription = button.getAttribute('data-event-description');
            showEditEventModal(eventName, eventDescription);
        }

        function showEditEventModal(eventName, description) {
            // Pre-fill the form with current values
            document.getElementById('editEventName').value = eventName || '';
            document.getElementById('editDescription').value = description || '';

            // Update character counter for pre-filled content
            updateCharacterCount();

            // Hide any previous error messages
            document.getElementById('editEventError').style.display = 'none';

            // Show the modal
            document.getElementById('editEventModal').classList.add('show');
        }

        function hideEditEventModal() {
            document.getElementById('editEventModal').classList.remove('show');

            // Clear form
            document.getElementById('editEventName').value = '';
            document.getElementById('editDescription').value = '';

            // Hide error message
            document.getElementById('editEventError').style.display = 'none';
        }

        function saveEventChanges() {
            const eventName = document.getElementById('editEventName').value.trim();
            const description = document.getElementById('editDescription').value.trim();

            // Basic validation
            if (!eventName) {
                showEditError('Event name is required');
                return;
            }

            if (eventName.length > 100) {
                showEditError('Event name cannot exceed 100 characters');
                return;
            }

            if (description.length > 200) {
                showEditError('Description cannot exceed 200 characters');
                return;
            }

            // Submit the form
            const formData = new FormData();
            formData.append('eventName', eventName);
            formData.append('description', description || '');

            fetch(`/chief/events/${eventId}/edit`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to show updated information
                        window.location.reload();
                    } else {
                        showEditError(data.message || 'Error updating event');
                    }
                })
                .catch(error => {
                    console.error('Error updating event:', error);
                    showEditError('Error updating event');
                });
        }

        function showEditError(message) {
            const errorDiv = document.getElementById('editEventError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function updateCharacterCount() {
            const textarea = document.getElementById('editDescription');
            const counter = document.getElementById('editDescriptionCount');
            const currentLength = textarea.value.length;
            counter.textContent = `${currentLength}/200 characters`;

            // Change color when approaching limit
            if (currentLength > 180) {
                counter.style.color = '#dc3545';
            } else if (currentLength > 160) {
                counter.style.color = '#ffc107';
            } else {
                counter.style.color = '#6c757d';
            }
        }
    </script>

    <!-- Include Toast Scripts -->
    <script th:replace="~{fragments/common/toast-notification :: toast-scripts}"></script>
</div>

</html>