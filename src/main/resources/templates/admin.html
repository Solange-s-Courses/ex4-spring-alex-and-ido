<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrator Dashboard</title>
</head>

<body>
<!-- Include Navbar Styles -->
<link rel="stylesheet" th:href="@{/css/admin-styles.css}">
<link rel="stylesheet" th:href="@{/css/navbar-styles.css}">

<!-- Navigation -->
<div th:with="showDashboardBtn=true, hideAdminPageBtn=true">
  <div th:replace="~{fragments/layout :: navbar}"></div>
</div>

<div class="container">
  <!-- Alert Messages -->
  <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
  <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

  <!-- Admin Content Area - Tabbed Section -->
  <div class="admin-content">
    <div class="tabs-section">
      <div class="tabs-header">
        <h2>Admin Control Panel</h2>
        <p class="tabs-subtitle">Management and Metrics</p>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-button active" data-tab="tab1" onclick="switchTab('tab1')">Users</button>
        <button class="tab-button" data-tab="tab2" onclick="switchTab('tab2')">Items</button>
        <button class="tab-button" data-tab="tab3" onclick="switchTab('tab3')">Events</button>
      </div>

      <!-- Tab Contents -->
      <div class="tab-content-wrapper">
        <!-- Tab 1 Content - Users Metrics + Admin Actions + User Management -->
        <div id="tab1" class="tab-content active">
          <!-- Users Section Container with side-by-side layout -->
          <div class="users-section-container">
            <!-- User Distribution Metrics (60% width) -->
            <div class="metric-card users-metrics">
              <div class="metric-card-header">
                <h3>User Distribution</h3>
                <p>Users by role</p>
              </div>
              <div class="chart-container">
                <div class="chart-wrapper">
                  <canvas id="userRoleChart"></canvas>
                </div>
                <div class="chart-legend">
                  <div class="legend-item">
                    <span class="legend-color chief-color"></span>
                    <span class="legend-label">Chief</span>
                    <span class="legend-count" id="chiefCount">0</span>
                  </div>
                  <div class="legend-item">
                    <span class="legend-color manager-color"></span>
                    <span class="legend-label">Manager</span>
                    <span class="legend-count" id="managerCount">0</span>
                  </div>
                  <div class="legend-item">
                    <span class="legend-color user-color"></span>
                    <span class="legend-label">User</span>
                    <span class="legend-count" id="userCount">0</span>
                  </div>
                  <div class="legend-total">
                    <span class="total-label">Total Users:</span>
                    <span class="total-count" id="totalUserCount">0</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Admin User Actions Section (40% width) -->
            <div class="metric-card admin-actions">
              <div class="metric-card-header">
                <h3>Admin User Actions</h3>
                <p>Bulk user management operations</p>
              </div>
              <div class="admin-actions-content">
                <div class="action-button-group">
                  <button class="admin-action-btn warning" onclick="makeAllManagersUser()">
                    Demote managers to user
                  </button>

                  <button class="admin-action-btn warning" onclick="makeAllChiefsUser()">
                    Demote chiefs to user
                  </button>

                  <button class="admin-action-btn danger" onclick="deleteAllUsers()">
                    Delete All Users
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- User Management Section (full width below) -->
          <div class="user-management-card">
            <div class="user-management-header">
              <h3>User Role Management</h3>
              <p>Manage chief role assignments</p>
            </div>

            <!-- Search and Filter Controls -->
            <div class="user-controls">
              <div class="search-container">
                <input type="text" id="userSearch" placeholder="Search by name, email, or phone..." class="search-input">
              </div>
              <div class="filter-container">
                <select id="roleFilter" class="filter-select">
                  <option value="all">All Users</option>
                  <option value="chief">Chiefs Only</option>
                  <option value="non-chief">Non-Chiefs</option>
                </select>
              </div>
            </div>

            <!-- User Table -->
            <div class="user-table-container">
              <div id="userTableLoading" class="loading-message">
                <div class="loading-spinner"></div>
                Loading users...
              </div>
              <div id="userTableEmpty" class="empty-message" style="display: none;">No users found</div>
              <div id="userTableWrapper" class="table-scroll-wrapper" style="display: none;">
                <table id="userTable" class="user-table">
                  <thead class="table-header-fixed">
                  <tr>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Current Role</th>
                    <th>Actions</th>
                  </tr>
                  </thead>
                  <tbody id="userTableBody">
                  <!-- Users will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab 2 Content -->
        <div id="tab2" class="tab-content">
          <div class="metric-card">
            <div class="metric-card-header">
              <h3>Item Status</h3>
              <p>Items by availability status</p>
            </div>
            <div class="chart-container">
              <div class="chart-wrapper">
                <canvas id="itemStatusChart"></canvas>
              </div>
              <div class="chart-legend">
                <div class="legend-item">
                  <span class="legend-color available-color"></span>
                  <span class="legend-label">Available</span>
                  <span class="legend-count" id="availableCount">0</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color inuse-color"></span>
                  <span class="legend-label">In Use</span>
                  <span class="legend-count" id="inUseCount">0</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color unavailable-color"></span>
                  <span class="legend-label">Unavailable</span>
                  <span class="legend-count" id="unavailableCount">0</span>
                </div>
                <div class="legend-total">
                  <span class="total-label">Total Items:</span>
                  <span class="total-count" id="totalItemCount">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab 3 Content -->
        <div id="tab3" class="tab-content">
          <div class="metric-card">
            <div class="metric-card-header">
              <h3>Event Status</h3>
              <p>Events by current status</p>
            </div>
            <div class="chart-container">
              <div class="chart-wrapper">
                <canvas id="eventStatusChart"></canvas>
              </div>
              <div class="chart-legend">
                <div class="legend-item">
                  <span class="legend-color not-active-color"></span>
                  <span class="legend-label">Not Active</span>
                  <span class="legend-count" id="notActiveCount">0</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color active-color"></span>
                  <span class="legend-label">Active</span>
                  <span class="legend-count" id="activeCount">0</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color equipment-return-color"></span>
                  <span class="legend-label">Equipment Return</span>
                  <span class="legend-count" id="equipmentReturnCount">0</span>
                </div>
                <div class="legend-total">
                  <span class="total-label">Total Events:</span>
                  <span class="total-count" id="totalEventCount">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->

<!-- Delete User Confirmation Modal -->
<div id="deleteUserModal" class="delete-modal">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <h3>Delete User</h3>
      <button class="delete-modal-close" onclick="hideDeleteUserModal()">&times;</button>
    </div>
    <div class="delete-modal-body">
      <div class="delete-warning-icon">⚠️</div>
      <p class="delete-warning-text">Are you sure you want to delete this user?</p>
      <div class="user-details">
        <div class="user-detail-item">
          <strong>Name:</strong> <span id="deleteUserName">-</span>
        </div>
        <div class="user-detail-item">
          <strong>Role:</strong> <span id="deleteUserRole" class="role-badge">-</span>
        </div>
      </div>
      <div class="delete-consequences">
        <p><strong>This action will:</strong></p>
        <ul>
          <li>Permanently remove the user from the system</li>
          <li>Remove user from any assigned responsibilities</li>
          <li>Cancel all user requests and return items to available status</li>
          <li>Delete the responsibility if user was the last manager</li>
        </ul>
        <p class="delete-warning-final"><strong>This action cannot be undone.</strong></p>
      </div>
    </div>
    <div class="delete-modal-footer">
      <button class="btn-cancel" onclick="hideDeleteUserModal()">Cancel</button>
      <button class="btn-delete-confirm" onclick="confirmDeleteUser()">Delete User</button>
    </div>
  </div>
</div>

<!-- Demote All Managers Confirmation Modal -->
<div id="demoteManagersModal" class="delete-modal">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <h3>Demote All Managers</h3>
      <button class="delete-modal-close" onclick="hideDemoteManagersModal()">&times;</button>
    </div>
    <div class="delete-modal-body">
      <div class="delete-warning-icon">⚠️</div>
      <p class="delete-warning-text">Are you sure you want to demote all managers to user role?</p>
      <div class="user-details">
        <div class="user-detail-item">
          <strong>Managers to demote:</strong> <span id="managerCountDisplay">0</span>
        </div>
      </div>
      <div class="delete-consequences">
        <p><strong>This action will:</strong></p>
        <ul>
          <li>Change all manager roles to regular user role</li>
          <li>Remove all managers from their assigned responsibilities</li>
          <li>Delete responsibilities that have no remaining managers</li>
          <li>Cancel all requests for items in deleted responsibilities</li>
        </ul>
        <p class="delete-warning-final"><strong>This action cannot be undone.</strong></p>
      </div>
      <!-- Progress Section (hidden initially) -->
      <div id="demoteProgress" class="progress-section" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="demoteProgressFill"></div>
        </div>
        <p class="progress-text" id="demoteProgressText">Processing...</p>
      </div>
    </div>
    <div class="delete-modal-footer">
      <button class="btn-cancel" onclick="hideDemoteManagersModal()" id="demoteCancelBtn">Cancel</button>
      <button class="btn-delete-confirm" onclick="confirmDemoteAllManagers()" id="demoteConfirmBtn">Demote All Managers</button>
    </div>
  </div>
</div>

<!-- Demote All Chiefs Confirmation Modal -->
<div id="demoteChiefsModal" class="delete-modal">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <h3>Demote All Chiefs</h3>
      <button class="delete-modal-close" onclick="hideDemoteChiefsModal()">&times;</button>
    </div>
    <div class="delete-modal-body">
      <div class="delete-warning-icon">⚠️</div>
      <p class="delete-warning-text">Are you sure you want to demote all chiefs to user role?</p>
      <div class="user-details">
        <div class="user-detail-item">
          <strong>Chiefs to demote:</strong> <span id="chiefCountDisplay">0</span>
        </div>
      </div>
      <div class="delete-consequences">
        <p><strong>This action will:</strong></p>
        <ul>
          <li>Change all chief roles to regular user role</li>
          <li>Remove all elevated privileges from chiefs</li>
          <li>System will have no chiefs after this operation</li>
        </ul>
        <p class="delete-warning-final"><strong>This action cannot be undone.</strong></p>
      </div>
      <!-- Progress Section (hidden initially) -->
      <div id="demoteChiefsProgress" class="progress-section" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="demoteChiefsProgressFill"></div>
        </div>
        <p class="progress-text" id="demoteChiefsProgressText">Processing...</p>
      </div>
    </div>
    <div class="delete-modal-footer">
      <button class="btn-cancel" onclick="hideDemoteChiefsModal()" id="demoteChiefsCancelBtn">Cancel</button>
      <button class="btn-delete-confirm" onclick="confirmDemoteAllChiefs()" id="demoteChiefsConfirmBtn">Demote All Chiefs</button>
    </div>
  </div>
</div>

<!-- Delete All Users Confirmation Modal -->
<div id="deleteAllUsersModal" class="delete-modal">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <h3>Delete All Users</h3>
      <button class="delete-modal-close" onclick="hideDeleteAllUsersModal()">&times;</button>
    </div>
    <div class="delete-modal-body">
      <div class="delete-warning-icon">⚠️</div>
      <p class="delete-warning-text">Are you sure you want to delete ALL users from the system?</p>
      <div class="user-details">
        <div class="user-detail-item">
          <strong>Users to delete:</strong> <span id="allUsersCountDisplay">0</span>
        </div>
      </div>
      <div class="delete-consequences">
        <p><strong>This DESTRUCTIVE action will:</strong></p>
        <ul>
          <li>Permanently delete ALL non-admin users</li>
          <li>Remove all user assignments from responsibilities</li>
          <li>Delete all responsibilities with no remaining managers</li>
          <li>Set all user-owned items to "Unavailable" status</li>
          <li>Cancel ALL user requests in the system</li>
          <li>Clear all user data permanently</li>
        </ul>
        <p class="delete-warning-final"><strong>THIS ACTION CANNOT BE UNDONE AND WILL RESET THE ENTIRE SYSTEM!</strong></p>
      </div>
      <!-- Progress Section (hidden initially) -->
      <div id="deleteAllProgress" class="progress-section" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="deleteAllProgressFill"></div>
        </div>
        <p class="progress-text" id="deleteAllProgressText">Processing...</p>
      </div>
    </div>
    <div class="delete-modal-footer">
      <button class="btn-cancel" onclick="hideDeleteAllUsersModal()" id="deleteAllCancelBtn">Cancel</button>
      <button class="btn-delete-confirm" onclick="confirmDeleteAllUsers()" id="deleteAllConfirmBtn">Delete All Users</button>
    </div>
  </div>
</div>

<div th:replace="~{fragments/common/toast :: toast-system}"></div>

<!-- Chart.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<!-- Include Scripts -->
<script th:src="@{/js/navbar-scripts.js}"></script>
<script th:src="@{/js/admin-scripts.js}"></script>

</body>
</html>